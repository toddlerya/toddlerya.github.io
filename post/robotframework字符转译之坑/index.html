<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>robotframework字符转译之坑 - 不期速成日拱一卒</title>
    <meta name="keywords" content="不期速成日拱一卒,独立,博客,程序员,个人,思考,读书,笔记,技术,分享,Golang">
    
    <meta property="og:title" content="robotframework字符转译之坑">
    <meta property="og:site_name" content="不期速成日拱一卒">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="robotframework字符转译之坑 - 不期速成日拱一卒" />
    <meta name="description" content="不期速成日拱一卒 | 博客 | 软件 | 测试 | Python | Golang"> 
    <link rel="shortcut icon" href="https://toddlerya.github.io/img/favicon.ico" />
    <link rel="apple-touch-icon" href="https://toddlerya.github.io/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="https://toddlerya.github.io/img/apple-touch-icon.png" />
    <link href="https://toddlerya.github.io/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="https://toddlerya.github.io/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="https://toddlerya.github.io/css/main.css" rel="stylesheet" type="text/css" />
    <link href="https://toddlerya.github.io/css/syntax.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="https://toddlerya.github.io/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">不期速成日拱一卒</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">但行好事，莫问前程。</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="https://toddlerya.github.io/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://toddlerya.github.io/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="https://toddlerya.github.io/post/robotframework%E5%AD%97%E7%AC%A6%E8%BD%AC%E8%AF%91%E4%B9%8B%E5%9D%91/" itemprop="url">
        robotframework字符转译之坑
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2019-04-08">
    2019-04-08
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="https://toddlerya.github.io/categories/%E7%AC%94%E8%AE%B0" itemprop="url" rel="index">
        <span itemprop="name">笔记</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">1608 字 ~4分钟</span>
</span>
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    

<p>去年在公司推广了robotframework自动化框架，基于此框架我们设计开发了HTTPTestLibrary关键字库开展接口测试，效果挺好。我们部门测试开发的统一Python版本为python2.7，因为在我来公司前就在用这个版本，虽然2020年社区不再提供支持，但我们目前还没有迁移Python3的计划，这是前提。</p>

<h1 id="有点别致的json">有点别致的JSON</h1>

<p>说到接口测试，必然要支持解析处理各种请求体，其中，我们的研发在某些项目的接口中使用了这样的请求体，我举个例子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{<span style="color:#f92672">&#34;key1&#34;</span>: <span style="color:#ae81ff">123</span>, <span style="color:#f92672">&#34;trouble&#34;</span>: <span style="color:#e6db74">&#34;{\&#34;inner\&#34;: \&#34;hehe\&#34;}&#34;</span>}</code></pre></div>
<p>JSON里嵌套一个JSON对象，还是个字符串型的，这是个标准的JSON类型嘛？？？google得知如下知识</p>

<p><img src="https://toddlerya.github.io/images/json_org_doc.png" alt="json_org_doc" /></p>

<p>我们用Python测试下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">8</span>]: json_str <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;&#39;&#39;{&#34;key1&#34;: 123, &#34;trouble&#34;: &#34;{\&#34;inner\&#34;: \&#34;hehe\&#34;}&#34;}&#39;&#39;&#39;</span>

In [<span style="color:#ae81ff">9</span>]: json_str
Out[<span style="color:#ae81ff">9</span>]: <span style="color:#e6db74">&#39;{&#34;key1&#34;: 123, &#34;trouble&#34;: &#34;{</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;inner</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;: </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;hehe</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;}&#34;}&#39;</span>

In [<span style="color:#ae81ff">10</span>]: <span style="color:#66d9ef">print</span>(json_str)
{<span style="color:#e6db74">&#34;key1&#34;</span>: <span style="color:#ae81ff">123</span>, <span style="color:#e6db74">&#34;trouble&#34;</span>: <span style="color:#e6db74">&#34;{</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">inner</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">hehe</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">}&#34;</span>}

In [<span style="color:#ae81ff">11</span>]: <span style="color:#f92672">import</span> json

In [<span style="color:#ae81ff">12</span>]: json<span style="color:#f92672">.</span>loads(json_str)
Out[<span style="color:#ae81ff">12</span>]: {<span style="color:#e6db74">&#39;key1&#39;</span>: <span style="color:#ae81ff">123</span>, <span style="color:#e6db74">&#39;trouble&#39;</span>: <span style="color:#e6db74">&#39;{&#34;inner&#34;: &#34;hehe&#34;}&#39;</span>}

In [<span style="color:#ae81ff">13</span>]: type(json<span style="color:#f92672">.</span>loads(json_str))
Out[<span style="color:#ae81ff">13</span>]: dict</code></pre></div>
<p>研发定义的请求体没毛病，接下来看看我们的Python2的robotframework遇到什么问题了。</p>

<h1 id="robotframework测试用例">robotframework测试用例</h1>

<p>我们的robotframework测试用例如下：</p>

<p><img src="https://toddlerya.github.io/images/rf_test_case.png" alt="rf_test_case" /></p>

<p>基于我们对robotframework的了解，robotframework会读取文本格式的robot测试用例，经过解析加载为内存对象，构建测试用例，我们先分别使用Python2和Python3读取测试用例，看看效果是什么样子：</p>

<p><img src="https://toddlerya.github.io/images/py2_py3_read_rf_case.jpg" alt="py2_py3_read_rf_case" /></p>

<p>可以看到，虽然python2和python3对字符串的类型处理方式不同，但是对于我们的测试用例文本，都只进行了转译加上了一个<code>\</code>。</p>

<p>为了方便定位问题，便于观察，我们统一修改了robotframework的源码，增加了文本用例解析的输出</p>

<p><img src="https://toddlerya.github.io/images/rf_source_code.png" alt="rf_source_code" /></p>

<h1 id="python2版本的robotframework同学登场">Python2版本的robotframework同学登场</h1>

<p>先看下robotframework的测试执行结果，看起来没毛病。</p>

<p><img src="https://toddlerya.github.io/images/py2_rf_log.png" alt="py2_rf_log" /></p>

<p>再看看测试用例的debug输出：</p>

<p><img src="https://toddlerya.github.io/images/py2_rf_debug.png" alt="py2_rf_debug" /></p>

<p>WTF！为神马变成了四个<code>\</code>???，这就是导致我们的请求体异常，接口响应错误的根本原因啊！</p>

<p>可是在上面的的Python2直接读取测试用例表现的不是这样啊！</p>

<p>稳住，我们不能冤枉Python2同学，我们看看Python3的表现。</p>

<h1 id="python3版本的robot-framework同学低调入场">Python3版本的robot framework同学低调入场</h1>

<blockquote>
<p>Python3版本我们使用pipenv创建了一个虚拟环境，同样也修改了robotframework的源码，输出repr</p>
</blockquote>

<p>按惯例先看看Python3版本的robotframework的测试执行结果：</p>

<p><img src="https://toddlerya.github.io/images/py3_rf_log.png" alt="py3_rf_log" /></p>

<p>看起来和python2版本的一模一样，再看看测试用例的debug输出：</p>

<p><img src="https://toddlerya.github.io/images/py3_rf_debug.png" alt="py3_rf_debug" /></p>

<p>一切正常，完美！这样的结果才是我们想要的，这样的结果才能保证我们的接口响应正常。</p>

<h1 id="蛛丝马迹">蛛丝马迹</h1>

<p>我们再仔细阅读下源码，robotframework到底是怎么读取的文本用例：</p>

<p><img src="https://toddlerya.github.io/images/rf_source_open_mode.png" alt="rf_source_open_mode" /></p>

<p>robotframework是以<code>rb</code>模式打开文件进行读取的。</p>

<p>Python官方文档是这么说的：</p>

<blockquote>
<p>通常文件是以 <em>text mode</em> 打开的，这意味着从文件中读取或写入字符串时，都会以指定的编码方式进行编码。如果未指定编码格式，默认值与平台相关 (参见 <a href="https://docs.python.org/zh-cn/3/library/functions.html#open"><code>open()</code></a>)。在mode 中追加的 <code>'b'</code> 则以 <em>binary mode</em> 打开文件：现在数据是以字节对象的形式进行读写的。这个模式应该用于所有不包含文本的文件。</p>
</blockquote>

<p>但是我们进行debug输出时，python2版本却输出的是<code>&lt;type 'str'&gt;</code>类型，python3版本输出的是<code>&lt;class bytes&gt;</code>类型，显然Python2版本的robotframework在搞事情！</p>

<p>Python 3最重要的新特性大概要算是对文本和二进制数据作了更为清晰的区分。文本总是Unicode，由str类型表示，二进制数据则由bytes类型表示。Python 3不会以任意隐式的方式混用str和bytes，正是这使得两者的区分特别清晰。</p>

<p>至此，真相逐渐浮出水面了，不过我们还是不知道为什么Python2版本的robotframework会出现这种情况，但我们可以肯定的是，尽早的迁移到Python3，一定是一件正确的事情！</p>

<blockquote>
<p>Reference</p>

<p><a href="http://www.json.org/json-zh.html">http://www.json.org/json-zh.html</a>
<a href="https://blog.csdn.net/lgysjfs/article/details/86678559">https://blog.csdn.net/lgysjfs/article/details/86678559</a>
<a href="http://www.ituring.com.cn/article/1116">http://www.ituring.com.cn/article/1116</a>
<a href="https://stackoverflow.com/questions/9644110/difference-between-parsing-a-text-file-in-r-and-rb-mode/9644141#9644141">https://stackoverflow.com/questions/9644110/difference-between-parsing-a-text-file-in-r-and-rb-mode/9644141#9644141</a>
<a href="https://docs.python.org/zh-cn/3/tutorial/inputoutput.html#reading-and-writing-files">https://docs.python.org/zh-cn/3/tutorial/inputoutput.html#reading-and-writing-files</a>
<a href="https://docs.python.org/zh-cn/2.7/tutorial/inputoutput.html#reading-and-writing-files">https://docs.python.org/zh-cn/2.7/tutorial/inputoutput.html#reading-and-writing-files</a></p>
</blockquote>

<hr />

<p>2019年04月08日 于 南京<br />
<a href="toddlerya@qq.com">Email</a><br />
<a href="https://github.com/toddlerya">GitHub</a></p>

    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="https://toddlerya.github.io/tags/robotframework" rel="tag" title="robotframework">#robotframework#</a>
    
    <a href="https://toddlerya.github.io/tags/python" rel="tag" title="python">#python#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="https://toddlerya.github.io/post/%E5%BD%93%E5%BC%80%E5%8F%91%E5%9B%A2%E9%98%9F%E5%BC%80%E5%A7%8B%E7%94%A8docker%E6%B5%8B%E8%AF%95%E5%9B%A2%E9%98%9F%E5%BA%94%E8%AF%A5%E5%81%9A%E4%BB%80%E4%B9%88/" rel="next" title="当开发团队开始用Docker，测试团队应该做什么？">
        <i class="fa fa-chevron-left"></i> 当开发团队开始用Docker，测试团队应该做什么？
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="https://toddlerya.github.io/post/limit%E5%92%8Cifnull%E7%9A%84%E4%BD%BF%E7%94%A8leetcode-sqlno.176/" rel="prev" title="LIMIT和IFNULL的使用：LeetCode No.176">
        LIMIT和IFNULL的使用：LeetCode No.176 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     




    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="https://toddlerya.github.io/img/dog.jpg"
        alt="toddlerya" />
    <p class="site-author-name" itemprop="name">toddlerya</p>
    <p class="site-description motion-element" itemprop="description"> 
        witness me.</p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="https://toddlerya.github.io/post/">
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="https://toddlerya.github.io/categories/">      
         
        <span class="site-state-item-count">9</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="https://toddlerya.github.io/tags/">
         
        <span class="site-state-item-count">17</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/toddlerya/" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
</div>


      

      <div class="links-of-blogroll motion-element inline">
<script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5pjfu6zttkq&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=lucida_sans_unicode&amp;l=33&amp;bv=35" async="async"></script>
</div>

    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2019</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">不期速成日拱一卒</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.53</a>
</div>
<div class="theme-info">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="https://toddlerya.github.io/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="https://toddlerya.github.io/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="https://toddlerya.github.io/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="https://toddlerya.github.io/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="https://toddlerya.github.io/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="https://toddlerya.github.io/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="https://toddlerya.github.io/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="https://toddlerya.github.io/js/utils.js"></script>
<script type="text/javascript" src="https://toddlerya.github.io/js/motion.js"></script>
<script type="text/javascript" src="https://toddlerya.github.io/js/affix.js"></script>
<script type="text/javascript" src="https://toddlerya.github.io/js/schemes/pisces.js"></script>

<script type="text/javascript" src="https://toddlerya.github.io/js/scrollspy.js"></script>
<script type="text/javascript" src="https://toddlerya.github.io/js/post-details.js"></script>
<script type="text/javascript" src="https://toddlerya.github.io/js/toc.js"></script>

<script type="text/javascript" src="https://toddlerya.github.io/js/bootstrap.js"></script>

<script type="text/javascript" src="https://toddlerya.github.io/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
</body>
</html>